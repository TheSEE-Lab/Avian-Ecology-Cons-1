
---
title: "eBird Yucatan Practical"
format:
  html:
    toc: true
    code-fold: true
editor: source
lang: en
---

# Overview

You will work with three small teaching datasets supplied with this practical:

- `ebird_yucatan_checklists.csv` – checklist-level data (location, date, land cover, effort).
- `ebird_yucatan.csv` – species-level detections linked to checklists.
- `ebird_yucatan_traits.csv` – simple functional traits for a subset of Yucatan bird species.

The workflow is **loosely inspired** by:

- Stewart et al. (2025) – threat abatement and conservation of global bird diversity.
- Matthews et al. (2024) – global loss of avian functional and phylogenetic diversity.

We will not reproduce the papers, but we will **borrow their ideas**:
habitat loss, extinction risk, and functional diversity.


# 0. Getting started

## 0.1. Set your working directory

Place all files in the same directory:

- this Quarto file: `ebird_yucatan_practical.qmd`
- `ebird_yucatan_checklists.csv`
- `ebird_yucatan.csv`
- `ebird_yucatan_traits.csv`

Then set the working directory in R (only if needed):

```{r}
# setwd("path/to/your/folder")  # <- adjust and uncomment if necessary
```


# 0A. Initial data exploration with Microsoft Excel

Before diving into R, let's get familiar with the datasets using Microsoft Excel (or LibreOffice Calc, Google Sheets, etc.). Open the three CSV files in your spreadsheet software.

## Exercise 0A.1: Exploring the checklist data

Open `ebird_yucatan_checklists.csv` in Excel.

**Tasks:**

1. **Count rows**: How many checklists are in the dataset?  
   *Hint: Look at the row numbers or use `=COUNTA()` function.*

2. **Examine columns**: What variables are recorded for each checklist?  
   List at least 5 column names.

3. **Date range**: What are the earliest and latest observation dates?  
   *Hint: Sort the `date` column or use `=MIN()` and `=MAX()` functions.*

4. **Land cover types**: How many different land cover categories are there?  
   *Hint: Use a Pivot Table or filter the `land_cover` column to see unique values.*

5. **Species richness**: Create a simple histogram of `n_species` values.
   - Select the `n_species` column
   - Insert → Chart → Histogram
   - What is the typical range of species per checklist?

6. **Effort hours**: What is the average effort in hours per checklist?  
   *Hint: Use `=AVERAGE()` on the `effort_hours` column.*

## Exercise 0A.2: Exploring the species detection data

Open `ebird_yucatan.csv` in Excel.

**Tasks:**

1. **Total observations**: How many species detection records are there?

2. **Species diversity**: How many unique species are in the dataset?  
   *Hint: Copy the `scientific_name` column to a new sheet, then use Remove Duplicates (Data tab).*

3. **Most common species**: Use a Pivot Table to find the most frequently detected species:
   - Create a Pivot Table with `scientific_name` in Rows
   - Add `checklist_ID` to Values (Count)
   - Sort by count descending
   - Which species appears in the most checklists?

4. **Abundance patterns**: What is the maximum count recorded for any species in a single checklist?  
   *Hint: Use `=MAX()` on the `count` column.*

5. **Link to checklists**: Pick one `checklist_ID` value and see how many species were recorded on that checklist.  
   *Hint: Use AutoFilter on the `checklist_ID` column.*

## Exercise 0A.3: Exploring the trait data

Open `ebird_yucatan_traits.csv` in Excel.

**Tasks:**

1. **Trait coverage**: How many species have trait data available?

2. **Body mass range**: What are the smallest and largest body masses in the dataset?  
   *Hint: Use `=MIN()` and `=MAX()` on `body_mass_g`.*

3. **Trophic niches**: What different trophic niche categories are present?  
   *Hint: Filter or create a Pivot Table on `trophic_niche`.*

4. **Trait relationships**: Create a scatter plot of `body_mass_g` vs `wing_length`:
   - Select both columns
   - Insert → Chart → Scatter plot
   - Do you see any relationship?

5. **Beak dimensions**: Which species has the longest beak (culmen)?  
   *Hint: Sort by `beak_length_culmen` descending.*

## Exercise 0A.4: Linking datasets (challenge - for homework)

**Tasks:**

1. Using Excel's `VLOOKUP` or `XLOOKUP`, try to match species from the detection file to their traits:
   - In the detections file, add a new column for `body_mass_g`
   - Use a lookup formula to fetch body mass from the traits file
   - Formula example: `=VLOOKUP(B2, traits!A:B, 2, FALSE)`

2. Calculate the average body mass of species detected in your first checklist.

**Reflection questions:**

- What patterns did you notice in the data?
- Which land cover type has the most sampling effort?
- What are some challenges of working with these data in Excel?
- What questions would be easier to answer with R?


## 0.2. Load required packages

We will use only widely available R packages. First - install, manually, the `pacman` package if needed.

```{r message=FALSE, warning=FALSE}
library(pacman)

p_load(
    tidyverse, sf, rnaturalearth,
    rnaturalearthdata, FD,
    ggrepel, textshape
)
```

## 0.3. Load the datasets in R

Now we'll load the same datasets into R for more sophisticated analysis.

```{r}
checklists <- read_csv("ebird_yucatan_checklists.csv")
detections <- read_csv("ebird_yucatan.csv")
traits     <- read_csv("ebird_yucatan_traits.csv")

glimpse(checklists)
glimpse(detections)
glimpse(traits)
```

**Task 0.1 (students)**

1. How many checklists are there in the dataset? Compare with your Excel count.
2. Over which years do we have data?
3. Which land cover types are represented?


# 1. Mapping Yucatan Peninsula checklists and richness

In this part, we will:

1. Plot all checklists on a map of the Yucatan Peninsula region.
2. Compute basic species richness per checklist.
3. Visualise spatial variation in richness.

## 1.1. Regional boundary and checklist locations

```{r}
# get Yucatan Peninsula + surrounding regions boundaries
mx_states <- rnaturalearth::ne_states(country = "Mexico", returnclass = "sf") |>
  filter(name %in% c("Yucatán", "Campeche", "Quintana Roo", "Tabasco", "Chiapas"))
belize <- rnaturalearth::ne_countries(country = "Belize", returnclass = "sf")
guatemala <- rnaturalearth::ne_countries(country = "Guatemala", returnclass = "sf")

checklists_sf <- checklists |>
  st_as_sf(coords = c("longitude","latitude"), crs = 4326)

ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  geom_sf(data = checklists_sf, alpha = 0.6, size = 1) +
  coord_sf() +
  theme_minimal() +
  labs(title = "eBird-style checklists in Yucatan Peninsula region",
       x = "Longitude", y = "Latitude")
```

**Task 1.1**

- Which parts of the Yucatan Peninsula are sampled most densely?
- Do some land cover types seem under-sampled? (Use the code below to colour by land cover.)

```{r}
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  geom_sf(data = checklists_sf, aes(color = land_cover), alpha = 0.7) +
  theme_minimal() +
  labs(title = "Checklists by land cover type")
```

## 1.2. Species richness per checklist

The checklist data already include `n_species` (number of distinct species recorded).
We can visualise how richness varies spatially.

```{r}
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  geom_sf(data = checklists_sf, aes(color = n_species), size = 1) +
  scale_color_viridis_c(option = "plasma") +
  theme_minimal() +
  labs(title = "Species richness per checklist",
       color = "Richness")
```

**Task 1.2**

1. Which land cover types have the highest average species richness?
2. Use the code below to summarise richness by land cover and interpret the result.

```{r}
checklists |>
  group_by(land_cover) |>
  summarise(mean_richness = mean(n_species),
            sd_richness   = sd(n_species),
            n_checklists  = n())
```


## 1.3. Spatial density mapping: sampling effort and species abundance

To better understand spatial patterns in eBird data, we can create **density maps** using
kernel density estimation. This is useful for:

1. Visualising **sampling effort** (where are checklists concentrated?)
2. Mapping **species abundance** (where are particular species most abundant?)

We will use the `ggplot2::stat_density_2d()` function to create smooth density surfaces.

### 1.3.1. Sampling effort density

```{r}
# Create a bounding box for the region
region_bbox <- st_bbox(c(xmin = -92, xmax = -86, ymin = 15, ymax = 22), crs = 4326)

ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  stat_density_2d(data = checklists, 
                  aes(x = longitude, y = latitude, fill = after_stat(level)),
                  geom = "polygon", alpha = 0.5, bins = 10) +
  scale_fill_viridis_c(option = "magma") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = "eBird sampling effort density",
       subtitle = "Kernel density estimation of checklist locations",
       fill = "Density",
       x = "Longitude", y = "Latitude")
```

### 1.3.2. Species abundance density

Now let's map the spatial density of a particular species. We'll select a common species
and map where it's most frequently detected.

```{r}
# Choose a common species (adjust species_code as needed)
focal_species <- "yebsap"  # Yellow-bellied Sapsucker as example

# Get detections with location data
species_detections <- detections |>
  filter(species_code == focal_species) |>
  left_join(checklists |> select(checklist_ID, longitude, latitude), 
            by = "checklist_ID")

# Plot species abundance density
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  stat_density_2d(data = species_detections,
                  aes(x = longitude, y = latitude, fill = after_stat(level)),
                  geom = "polygon", alpha = 0.6, bins = 8) +
  scale_fill_viridis_c(option = "plasma") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = paste("Abundance density:", focal_species),
       subtitle = "Kernel density of species detections",
       fill = "Density",
       x = "Longitude", y = "Latitude")
```

### 1.3.3. Weighted abundance density

We can also weight the density by actual counts, giving more emphasis to locations
where the species was seen in higher numbers.

```{r}
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  stat_density_2d(data = species_detections,
                  aes(x = longitude, y = latitude, 
                      fill = after_stat(level), weight = count),
                  geom = "polygon", alpha = 0.6, bins = 8) +
  scale_fill_viridis_c(option = "plasma") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = paste("Weighted abundance density:", focal_species),
       subtitle = "Kernel density weighted by observation counts",
       fill = "Density",
       x = "Longitude", y = "Latitude")
```

### 1.3.4. Hexagonal binning for abundance extrapolation

Hexagonal bins provide an alternative way to visualize spatial patterns and can be used
to extrapolate species abundance across the region. This approach aggregates observations
into hexagonal cells, which provides a smooth representation while being computationally
efficient.

```{r}
# Hexbin map of sampling effort
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  geom_hex(data = checklists, 
           aes(x = longitude, y = latitude), 
           bins = 30, alpha = 0.7) +
  scale_fill_viridis_c(option = "magma", trans = "log10") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = "Sampling effort: hexagonal binning",
       subtitle = "Number of checklists per hexagonal cell",
       fill = "Checklists\n(log scale)",
       x = "Longitude", y = "Latitude")
```

```{r}
# Hexbin map of species abundance
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  geom_hex(data = species_detections,
           aes(x = longitude, y = latitude),
           bins = 25, alpha = 0.7) +
  scale_fill_viridis_c(option = "plasma", name = "Detections") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = paste("Species distribution:", focal_species),
       subtitle = "Hexagonal binning of detection locations",
       x = "Longitude", y = "Latitude")
```

```{r}
# Hexbin map weighted by abundance (sum of counts per cell)
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  stat_summary_hex(data = species_detections,
                   aes(x = longitude, y = latitude, z = count),
                   fun = sum, bins = 25, alpha = 0.7) +
  scale_fill_viridis_c(option = "plasma", name = "Total\ncount") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = paste("Abundance extrapolation:", focal_species),
       subtitle = "Total counts aggregated in hexagonal cells",
       x = "Longitude", y = "Latitude")
```

```{r}
# Mean abundance per hexagonal cell
ggplot() +
  geom_sf(data = mx_states, fill = "grey95", color = "grey40") +
  geom_sf(data = belize, fill = "grey90", color = "grey30") +
  geom_sf(data = guatemala, fill = "grey90", color = "grey30") +
  stat_summary_hex(data = species_detections,
                   aes(x = longitude, y = latitude, z = count),
                   fun = mean, bins = 25, alpha = 0.7) +
  scale_fill_viridis_c(option = "plasma", name = "Mean\ncount") +
  coord_sf(xlim = c(-92, -86), ylim = c(15, 22)) +
  theme_minimal() +
  labs(title = paste("Mean abundance:", focal_species),
       subtitle = "Average counts per hexagonal cell",
       x = "Longitude", y = "Latitude")
```

**Task 1.3**

1. Where is sampling effort most concentrated in the Yucatan Peninsula?
2. How does the distribution of your focal species compare to overall sampling effort?
3. Choose a different species from the dataset and create its abundance density map.
   What does this tell you about the species' distribution?
4. Why might it be important to account for sampling effort when interpreting
   species distribution patterns?
5. Compare the hexagonal binning approach to kernel density estimation. What are the
   advantages of each method?
6. How do the total count and mean count hexbin maps differ in their interpretation?
   Which is more useful for understanding species distribution?


# 2. Species trends: reporting rates over time

Inspired by conservation concerns in the papers, we can examine **reporting rates** of two
species through time in this teaching dataset.

## 2.1. Prepare annual reporting data

Reporting rate = proportion of complete checklists on which the species was recorded.

```{r}
# total number of checklists per year
total_per_year <- checklists |>
  count(year, name = "n_checklists")

# detections per species-year (presence on a checklist)
species_year <- detections |>
  distinct(checklist_ID, species_code) |>
  left_join(checklists |> select(checklist_ID, year), by = "checklist_ID") |>
  count(species_code, year, name = "n_checklists_with_species") |>
  left_join(total_per_year, by = "year") |>
  mutate(reporting_rate = n_checklists_with_species / n_checklists)

head(species_year)
```

## 2.2. Plot reporting rate trends

```{r}
# Select some species of interest
species_year |>
  filter(species_code %in% c("yebsap","plapar")) |>
  left_join(traits |> select(species_code, scientific_name), by = "species_code") |>
  ggplot(aes(x = year, y = reporting_rate, color = scientific_name)) +
  geom_line(size = 1) +
  geom_point() +
  theme_minimal() +
  labs(title = "Reporting rate trends for two focal species",
       y = "Reporting rate (proportion of checklists)",
       x = "Year",
       color = "Species")
```

**Task 2.1**

1. Compare the reporting rate trends of the two species.  
2. Which species appears more “secure” in the dataset? Why?
3. How might habitat loss (as in Stewart et al.) affect these trends in real data?


# 3. Land cover comparison: community composition

We want to know whether land cover types differ in their **species composition**.

## 3.1. Species-by-land-cover table

```{r}
# join detections to checklist land cover
det_with_hab <- detections |>
  left_join(checklists |> select(checklist_ID, land_cover), by = "checklist_ID")

species_habitat <- det_with_hab |>
  group_by(land_cover, scientific_name) |>
  summarise(n_checklists = n_distinct(checklist_ID),
            total_count  = sum(count), .groups = "drop")

species_habitat
```

## 3.2. Most frequently detected species per land cover

```{r}
species_habitat |>
  group_by(land_cover) |>
  slice_max(order_by = n_checklists, n = 5) |>
  arrange(land_cover, desc(n_checklists))
```

**Task 3.1**

1. Which species dominate urban vs forest checklists?  
2. Do the dominant species match your expectations for those land cover types?


# 4. Functional diversity by land cover

Now we bring in **functional traits** to approximate ideas from Matthews et al. (functional
diversity and non-random loss of traits).

We will:

1. Create a trait matrix for the species in our dataset.
2. Compute simple functional diversity (FD) indices for each land cover type.
3. Visualise trait structure across land cover types.

## 4.1. Trait matrix for species

We will use numeric traits:

- body mass (g)
- beak length culmen (mm)
- wing length (mm)
- beak width (mm)

```{r}
# species present in traits data
species_present <- traits |>
  distinct(scientific_name) |>
  pull()

traits_num <- traits |>
  filter(scientific_name %in% species_present) |>
  arrange(scientific_name) |>
  column_to_rownames("scientific_name") |>
  select(body_mass_g, beak_length_culmen, wing_length, beak_width)

head(traits_num)
```

## 4.2. Species relative abundance by land cover

`FD::dbFD()` expects species abundances (or presence–absence) per site.
Here, we treat **land cover types as sites** and use `total_count` as abundance.

```{r}
abund_habitat <- species_habitat |>
  filter(scientific_name %in% species_present) |>
  arrange(scientific_name) |>
  select(land_cover, scientific_name, total_count) |>
  pivot_wider(names_from = scientific_name, values_from = total_count, values_fill = 0) |>
  column_to_rownames("land_cover")

abund_habitat[, 1:7]
```

## 4.3. Compute functional diversity indices

We will calculate:

- FRic – functional richness (volume of convex hull in trait space)
- FEve – functional evenness
- FDiv – functional divergence
- RaoQ – Rao's quadratic entropy

```{r}
fd_res <- dbFD(traits_num, abund_habitat, calc.FRic = TRUE, calc.FDiv = TRUE,
               calc.FGR = FALSE, m = "max", messages = FALSE)

fd_indices <- tibble(
  land_cover = rownames(abund_habitat),
  FRic    = fd_res$FRic,
  FEve    = fd_res$FEve,
  FDiv    = fd_res$FDiv,
  RaoQ    = fd_res$RaoQ
)

fd_indices
```

## 4.4. Visualising functional diversity differences

```{r}
fd_indices_long <- fd_indices |>
  pivot_longer(cols = -land_cover, names_to = "index", values_to = "value")

ggplot(fd_indices_long, aes(x = land_cover, y = value, fill = land_cover)) +
  geom_col() +
  facet_wrap(~ index, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Functional diversity of bird communities by land cover")
```

**Task 4.1**

1. Which land cover type has the highest functional richness (FRic)?  
2. Does any land cover show low FRic but relatively high FEve or FDiv? How might that happen?  
3. Relate your findings to the idea that anthropogenic extinctions can be **trait-biased**
   and reduce specific ecological functions (Matthews et al.).


# 5. Trait distributions in different land cover types

We can also look directly at traits of species that dominate each land cover type.

## 5.1. Trait distributions weighted by abundance

```{r}
traits_long <- det_with_hab |>
  group_by(land_cover, scientific_name) |>
  summarise(total_count = sum(count), .groups = "drop") |>
  left_join(traits, by = "scientific_name")

ggplot(traits_long, aes(x = body_mass_g, weight = total_count, fill = land_cover)) +
  geom_histogram(alpha = 0.5, bins = 20, position = "identity") +
  theme_minimal() +
  labs(title = "Body mass distribution by land cover (abundance-weighted)",
       x = "Body mass (g)", y = "Weighted frequency")
```

**Task 5.1**

1. Are large-bodied species more frequent in any particular land cover type?  
2. How would selective loss of large-bodied species influence ecosystem functioning?

A similar plot can be made for wing or beak length. Try modifying the code above.


# 6. Optional extension: PCA of traits

For a more visual representation of the trait space, we can perform a simple PCA.

```{r}
traits_scaled <- scale(traits_num)
pca <- prcomp(traits_scaled)

pca_scores <- as_tibble(pca$x, rownames = "scientific_name") |>
  left_join(traits |> select(scientific_name, trophic_niche), by = "scientific_name")

ggplot(pca_scores, aes(x = PC1, y = PC2, label = scientific_name,
                       color = trophic_niche)) +
  geom_point(size = 2) +
  ggrepel::geom_text_repel(size = 3, max.overlaps = 20) +
  theme_minimal() +
  labs(title = "Trait space of Yucatan Peninsula birds (teaching dataset)",
       subtitle = "PC1/PC2 of body mass, beak length, wing length, beak width")
```

**Task 6.1 (optional)**

- Identify which traits mainly drive PC1 and PC2 (use `summary(pca)`).
- Discuss where species with different trophic niches lie in this space.


# 7. Wrap-up questions

1. How do species richness and functional diversity vary among land cover types in this dataset?  
2. If habitat loss continues in the Yucatan Peninsula, which land cover types (and associated communities) do you think are at greatest risk?  
3. How could you integrate **real eBird data** and **more detailed trait datasets** (e.g. AVONET)
   to test similar questions at larger scales?  
4. How do your findings conceptually link to the key messages of Stewart et al. and Matthews et al.?

You have completed the core practical. Feel free to extend the analyses, for example by:

- focusing on a single species of conservation concern;
- investigating latitudinal gradients;
- or comparing different regions within the Yucatan Peninsula.
